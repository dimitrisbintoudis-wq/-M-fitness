<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1f1a24">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>M Fitness</title>
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;M Fitness&quot;,&quot;short_name&quot;:&quot;M Fitness&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%231f1a24&quot;,&quot;theme_color&quot;:&quot;%231f1a24&quot;}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root {
      --primary: #e8a0b4;
      --primary-light: #f0c4d0;
      --primary-dim: rgba(232, 160, 180, 0.15);
      --secondary: #f5d5e0;
      --success: #9ed4be;
      --warning: #f5daa0;
      --danger: #e8a0a0;
      --bg: #1f1a24;
      --bg-card: #2a2430;
      --bg-input: #352f3a;
      --text: #f8f4f6;
      --text-dim: #c8bec4;
      --border: rgba(232, 160, 180, 0.2);
    }
    
    .light-mode {
      --primary: #a11d45;
      --primary-light: #c42858;
      --primary-dim: rgba(161, 29, 69, 0.25);
      --success: #0f6b3a;
      --warning: #8a6508;
      --danger: #b01c1c;
      --bg: #e8e0e4;
      --bg-card: #f5f0f2;
      --bg-input: #d4c8ce;
      --text: #1a1518;
      --text-dim: #3a3038;
      --border: rgba(161, 29, 69, 0.5);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Header */
    .header {
      background: var(--bg-card);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary-dim);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo-icon svg { width: 20px; height: 20px; stroke: var(--primary); }
    
    .logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .workout-timer {
      font-size: 14px;
      color: var(--primary);
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    
    .theme-toggle {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: var(--bg-input);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .theme-toggle svg { width: 20px; height: 20px; }
    
    /* Navigation */
    .nav {
      display: flex;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 61px;
      z-index: 99;
    }
    
    .nav-btn {
      flex: 1;
      padding: 12px 8px;
      border: none;
      background: transparent;
      color: var(--text-dim);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }
    
    .nav-btn.active {
      color: var(--primary);
      background: var(--primary-dim);
    }
    
    .nav-btn svg { width: 20px; height: 20px; }
    
    /* Main Content */
    .main { padding: 16px; padding-bottom: 100px; }
    
    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card-title svg { width: 18px; height: 18px; stroke: var(--primary); }
</style>
</head>
<body>
<div id="app"></div>
<script>
// ============ HELPERS ============
function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function startWorkoutFromData(dataKey) {
  const data = window._workoutData[dataKey];
  if (data) startWorkout(data.name, data.exercises);
}

window._workoutData = {};

// ============ DATA ============
const EXERCISES = {
  glutes: {
    emoji: 'ðŸ‘',
    name: 'Glutes / Î“Î»Î¿Ï…Ï„Î¿Î¯',
    exercises: ['Hip Thrust Machine / ÎÎ¸Î·ÏƒÎ· Î™ÏƒÏ‡Î¯Î¿Ï…', 'Cable Kickback / Î›Î¬ÎºÏ„Î¹ÏƒÎ¼Î± ÎšÎ±Î»Ï‰Î´Î¯Î¿Ï…', 'Hip Abduction Machine / Î‘Ï€Î±Î³Ï‰Î³Î® Î™ÏƒÏ‡Î¯Î¿Ï…', 'Hip Adduction Machine / Î ÏÎ¿ÏƒÎ±Î³Ï‰Î³Î® Î™ÏƒÏ‡Î¯Î¿Ï…', 'Glute Bridge / Î“Î­Ï†Ï…ÏÎ± Î“Î»Î¿Ï…Ï„ÏŽÎ½', 'Cable Pull-Through / ÎˆÎ»Î¾Î· ÎšÎ±Î»Ï‰Î´Î¯Î¿Ï…']
  },
  legs: {
    emoji: 'ðŸ¦µ',
    name: 'Legs / Î ÏŒÎ´Î¹Î±', 
    exercises: ['Leg Press / Î ÏÎ­ÏƒÎ± Î Î¿Î´Î¹ÏŽÎ½', 'Leg Extension / Î•ÎºÏ„Î¬ÏƒÎµÎ¹Ï‚', 'Lying Leg Curl / ÎšÎ¬Î¼ÏˆÎµÎ¹Ï‚ ÎžÎ±Ï€Î»Ï‰Ï„Î¬', 'Seated Leg Curl / ÎšÎ¬Î¼ÏˆÎµÎ¹Ï‚ ÎšÎ±Î¸Î¹ÏƒÏ„Î¬', 'Smith Squat / Î£ÎºÎ¿Ï…Î¬Ï„ Smith', 'Hack Squat / Hack Î£ÎºÎ¿Ï…Î¬Ï„', 'Calf Raise / Î“Î¬Î¼Ï€ÎµÏ‚', 'DB Squat / Î£ÎºÎ¿Ï…Î¬Ï„ Î¼Îµ Î‘Î»Ï„Î®ÏÎµÏ‚', 'Goblet Squat / Goblet Î£ÎºÎ¿Ï…Î¬Ï„', 'DB Lunges / Î ÏÎ¿Î²Î¿Î»Î­Ï‚ Î¼Îµ Î‘Î»Ï„Î®ÏÎµÏ‚']
  },
  chestBack: {
    emoji: 'ðŸ’ª',
    name: 'Chest & Back / Î£Ï„Î®Î¸Î¿Ï‚ & Î Î»Î¬Ï„Î·',
    exercises: ['Chest Press Machine / Î Î¹Î­ÏƒÎµÎ¹Ï‚ Î£Ï„Î®Î¸Î¿Ï…Ï‚', 'Pec Deck / Î ÎµÏ„Î±Î»Î¿ÏÎ´Î±', 'Lat Pulldown / ÎšÎ±Ï„Î±ÎºÏŒÏÏ…Ï†Î· ÎˆÎ»Î¾Î·', 'Seated Row / ÎšÏ‰Ï€Î·Î»Î±Ï„Î¹ÎºÎ®', 'Assisted Pull-up / Î¥Ï€Î¿Î²Î¿Î·Î¸Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ ÎˆÎ»Î¾ÎµÎ¹Ï‚', 'Cable Face Pulls / Face Pulls']
  },
  shoulders: {
    emoji: 'ðŸ‹ï¸',
    name: 'Shoulders / ÎÎ¼Î¿Î¹',
    exercises: ['Shoulder Press Machine / Î Î¹Î­ÏƒÎµÎ¹Ï‚ ÎÎ¼Ï‰Î½ ÎœÎ·Ï‡Î¬Î½Î·Î¼Î±', 'DB Shoulder Press / Î Î¹Î­ÏƒÎµÎ¹Ï‚ ÎÎ¼Ï‰Î½', 'DB Lateral Raise / Î Î»Î¬Î³Î¹ÎµÏ‚ Î†ÏÏƒÎµÎ¹Ï‚', 'DB Front Raise / ÎœÏ€ÏÎ¿ÏƒÏ„Î¹Î½Î­Ï‚ Î†ÏÏƒÎµÎ¹Ï‚', 'DB Rear Delt Raise / ÎŸÏ€Î¯ÏƒÎ¸Î¹Î¿Ï‚ Î”ÎµÎ»Ï„Î¿ÎµÎ¹Î´Î®Ï‚']
  },
  biceps: {
    emoji: 'ðŸ’ª',
    name: 'Biceps / Î”Î¹ÎºÎ­Ï†Î±Î»Î¿Î¹',
    exercises: ['DB Bicep Curl / ÎšÎ¬Î¼ÏˆÎ· Î”Î¹ÎºÎµÏ†Î¬Î»Î¿Ï…', 'DB Hammer Curl / Hammer Curl', 'Concentration Curl / Î£Ï…Î³ÎºÎ­Î½Ï„ÏÏ‰ÏƒÎ·Ï‚', 'Cable Bicep Curl / ÎšÎ¬Î¼ÏˆÎ· ÎšÎ±Î»Ï‰Î´Î¯Î¿Ï…']
  },
  triceps: {
    emoji: 'ðŸ’ª',
    name: 'Triceps / Î¤ÏÎ¹ÎºÎ­Ï†Î±Î»Î¿Î¹',
    exercises: ['Tricep Pushdown / Î Î¹Î­ÏƒÎµÎ¹Ï‚ Î¤ÏÎ¹ÎºÎµÏ†Î¬Î»Î¿Ï…', 'DB Tricep Kickback / Kickback', 'DB Overhead Extension / Î•ÎºÏ„Î¬ÏƒÎµÎ¹Ï‚ Î¥Ï€ÎµÏÎºÎ­Ï†Î±Î»Î±', 'Skull Crushers / Skull Crushers']
  },
  core: {
    emoji: 'ðŸ§˜',
    name: 'Core / ÎšÎ¿ÏÎ¼ÏŒÏ‚',
    exercises: ['Ab Crunch Machine / ÎšÎ¿Î¹Î»Î¹Î±ÎºÎ¿Î¯ ÎœÎ·Ï‡Î¬Î½Î·Î¼Î±', 'Cable Crunch / ÎšÎ¿Î¹Î»Î¹Î±ÎºÎ¿Î¯ ÎšÎ±Î»ÏŽÎ´Î¹Î¿', 'Back Extension / Î¥Ï€ÎµÏÎµÎºÏ„Î¬ÏƒÎµÎ¹Ï‚', 'Plank / Î£Î±Î½Î¯Î´Î±']
  },
  bodyweight: {
    emoji: 'ðŸƒ',
    name: 'Bodyweight / Î£Ï‰Î¼Î±Ï„Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚',
    exercises: ['Push Ups / ÎšÎ¬Î¼ÏˆÎµÎ¹Ï‚', 'Squats / ÎšÎ±Î¸Î¯ÏƒÎ¼Î±Ï„Î±', 'Lunges / Î ÏÎ¿Î²Î¿Î»Î­Ï‚', 'Triceps Dips / Î’Ï…Î¸Î¯ÏƒÎµÎ¹Ï‚', 'Burpees / Burpees']
  },
  cardio: {
    emoji: 'â¤ï¸',
    name: 'Cardio / ÎšÎ±ÏÎ´Î¹Î±Î³Î³ÎµÎ¹Î±ÎºÎ¬',
    exercises: ['Stair Climber / Î£ÎºÎ±Î»Î¿Ï€Î¬Ï„Î¹Î±', 'Incline Treadmill / Î”Î¹Î¬Î´ÏÎ¿Î¼Î¿Ï‚', 'Elliptical / Î•Î»Î»ÎµÎ¹Ï€Ï„Î¹ÎºÏŒ', 'Stationary Bike / Î Î¿Î´Î®Î»Î±Ï„Î¿'],
    isCardio: true
  }
};

const CARDIO_EXERCISES = ['Stair Climber / Î£ÎºÎ±Î»Î¿Ï€Î¬Ï„Î¹Î±', 'Incline Treadmill / Î”Î¹Î¬Î´ÏÎ¿Î¼Î¿Ï‚', 'Elliptical / Î•Î»Î»ÎµÎ¹Ï€Ï„Î¹ÎºÏŒ', 'Stationary Bike / Î Î¿Î´Î®Î»Î±Ï„Î¿'];

const PROGRAMS = {
  gluteFocus: {
    name: 'Glute Focus',
    days: [
      { name: 'Glutes + Hamstrings', exercises: ['Hip Thrust Machine / ÎÎ¸Î·ÏƒÎ· Î™ÏƒÏ‡Î¯Î¿Ï…', 'Cable Kickback / Î›Î¬ÎºÏ„Î¹ÏƒÎ¼Î± ÎšÎ±Î»Ï‰Î´Î¯Î¿Ï…', 'Lying Leg Curl / ÎšÎ¬Î¼ÏˆÎµÎ¹Ï‚ ÎžÎ±Ï€Î»Ï‰Ï„Î¬', 'Hip Abduction Machine / Î‘Ï€Î±Î³Ï‰Î³Î® Î™ÏƒÏ‡Î¯Î¿Ï…', 'Cable Pull-Through / ÎˆÎ»Î¾Î· ÎšÎ±Î»Ï‰Î´Î¯Î¿Ï…'] },
      { name: 'Quads + Calves', exercises: ['Leg Press / Î ÏÎ­ÏƒÎ± Î Î¿Î´Î¹ÏŽÎ½', 'Leg Extension / Î•ÎºÏ„Î¬ÏƒÎµÎ¹Ï‚', 'Hack Squat / Hack Î£ÎºÎ¿Ï…Î¬Ï„', 'Calf Raise / Î“Î¬Î¼Ï€ÎµÏ‚', 'Hip Adduction Machine / Î ÏÎ¿ÏƒÎ±Î³Ï‰Î³Î® Î™ÏƒÏ‡Î¯Î¿Ï…'] },
      { name: 'Full Lower', exercises: ['Smith Squat / Î£ÎºÎ¿Ï…Î¬Ï„ Smith', 'Hip Thrust Machine / ÎÎ¸Î·ÏƒÎ· Î™ÏƒÏ‡Î¯Î¿Ï…', 'Seated Leg Curl / ÎšÎ¬Î¼ÏˆÎµÎ¹Ï‚ ÎšÎ±Î¸Î¹ÏƒÏ„Î¬', 'Leg Extension / Î•ÎºÏ„Î¬ÏƒÎµÎ¹Ï‚', 'Glute Bridge / Î“Î­Ï†Ï…ÏÎ± Î“Î»Î¿Ï…Ï„ÏŽÎ½'] }
    ]
  },
  fullBody: {
    name: 'Full Body Toning',
    days: [
      { name: 'Push', exercises: ['Chest Press Machine / Î Î¹Î­ÏƒÎµÎ¹Ï‚ Î£Ï„Î®Î¸Î¿Ï…Ï‚', 'Shoulder Press Machine / Î Î¹Î­ÏƒÎµÎ¹Ï‚ ÎÎ¼Ï‰Î½ ÎœÎ·Ï‡Î¬Î½Î·Î¼Î±', 'Tricep Pushdown / Î Î¹Î­ÏƒÎµÎ¹Ï‚ Î¤ÏÎ¹ÎºÎµÏ†Î¬Î»Î¿Ï…', 'Pec Deck / Î ÎµÏ„Î±Î»Î¿ÏÎ´Î±', 'DB Lateral Raise / Î Î»Î¬Î³Î¹ÎµÏ‚ Î†ÏÏƒÎµÎ¹Ï‚'] },
      { name: 'Pull + Core', exercises: ['Lat Pulldown / ÎšÎ±Ï„Î±ÎºÏŒÏÏ…Ï†Î· ÎˆÎ»Î¾Î·', 'Seated Row / ÎšÏ‰Ï€Î·Î»Î±Ï„Î¹ÎºÎ®', 'Cable Bicep Curl / ÎšÎ¬Î¼ÏˆÎ· ÎšÎ±Î»Ï‰Î´Î¯Î¿Ï…', 'Cable Face Pulls / Face Pulls', 'Ab Crunch Machine / ÎšÎ¿Î¹Î»Î¹Î±ÎºÎ¿Î¯ ÎœÎ·Ï‡Î¬Î½Î·Î¼Î±'] },
      { name: 'Legs + Glutes', exercises: ['Leg Press / Î ÏÎ­ÏƒÎ± Î Î¿Î´Î¹ÏŽÎ½', 'Hip Thrust Machine / ÎÎ¸Î·ÏƒÎ· Î™ÏƒÏ‡Î¯Î¿Ï…', 'Leg Extension / Î•ÎºÏ„Î¬ÏƒÎµÎ¹Ï‚', 'Lying Leg Curl / ÎšÎ¬Î¼ÏˆÎµÎ¹Ï‚ ÎžÎ±Ï€Î»Ï‰Ï„Î¬', 'Hip Abduction Machine / Î‘Ï€Î±Î³Ï‰Î³Î® Î™ÏƒÏ‡Î¯Î¿Ï…'] }
    ]
  },
  upperLower: {
    name: 'Upper/Lower Split',
    days: [
      { name: 'Upper A', exercises: ['Chest Press Machine / Î Î¹Î­ÏƒÎµÎ¹Ï‚ Î£Ï„Î®Î¸Î¿Ï…Ï‚', 'Lat Pulldown / ÎšÎ±Ï„Î±ÎºÏŒÏÏ…Ï†Î· ÎˆÎ»Î¾Î·', 'Shoulder Press Machine / Î Î¹Î­ÏƒÎµÎ¹Ï‚ ÎÎ¼Ï‰Î½ ÎœÎ·Ï‡Î¬Î½Î·Î¼Î±', 'Cable Bicep Curl / ÎšÎ¬Î¼ÏˆÎ· ÎšÎ±Î»Ï‰Î´Î¯Î¿Ï…', 'Tricep Pushdown / Î Î¹Î­ÏƒÎµÎ¹Ï‚ Î¤ÏÎ¹ÎºÎµÏ†Î¬Î»Î¿Ï…'] },
      { name: 'Lower A', exercises: ['Leg Press / Î ÏÎ­ÏƒÎ± Î Î¿Î´Î¹ÏŽÎ½', 'Hip Thrust Machine / ÎÎ¸Î·ÏƒÎ· Î™ÏƒÏ‡Î¯Î¿Ï…', 'Leg Extension / Î•ÎºÏ„Î¬ÏƒÎµÎ¹Ï‚', 'Lying Leg Curl / ÎšÎ¬Î¼ÏˆÎµÎ¹Ï‚ ÎžÎ±Ï€Î»Ï‰Ï„Î¬', 'Calf Raise / Î“Î¬Î¼Ï€ÎµÏ‚'] },
      { name: 'Upper B', exercises: ['Seated Row / ÎšÏ‰Ï€Î·Î»Î±Ï„Î¹ÎºÎ®', 'Pec Deck / Î ÎµÏ„Î±Î»Î¿ÏÎ´Î±', 'DB Shoulder Press / Î Î¹Î­ÏƒÎµÎ¹Ï‚ ÎÎ¼Ï‰Î½', 'DB Hammer Curl / Hammer Curl', 'DB Overhead Extension / Î•ÎºÏ„Î¬ÏƒÎµÎ¹Ï‚ Î¥Ï€ÎµÏÎºÎ­Ï†Î±Î»Î±'] },
      { name: 'Lower B', exercises: ['Smith Squat / Î£ÎºÎ¿Ï…Î¬Ï„ Smith', 'Hip Abduction Machine / Î‘Ï€Î±Î³Ï‰Î³Î® Î™ÏƒÏ‡Î¯Î¿Ï…', 'Hack Squat / Hack Î£ÎºÎ¿Ï…Î¬Ï„', 'Seated Leg Curl / ÎšÎ¬Î¼ÏˆÎµÎ¹Ï‚ ÎšÎ±Î¸Î¹ÏƒÏ„Î¬', 'Cable Pull-Through / ÎˆÎ»Î¾Î· ÎšÎ±Î»Ï‰Î´Î¯Î¿Ï…'] }
    ]
  }
};

const SET_TYPES = [
  { id: 'W', label: 'Warmup', color: '#f5daa0' },
  { id: '1', label: 'Working 1', color: '#e8a0b4' },
  { id: '2', label: 'Working 2', color: '#e8a0b4' },
  { id: '3', label: 'Working 3', color: '#e8a0b4' },
  { id: 'F', label: 'Failure', color: '#e8a0a0' }
];

// ============ STATE ============
let state = {
  activeTab: 'workout',
  currentWorkout: null,
  workouts: [],
  personalRecords: {},
  selectedProgram: 'gluteFocus',
  expandedWorkout: null,
  settings: {
    restTimer: { default: 90, sound: true, vibration: true },
    units: 'kg',
    theme: 'dark'
  },
  restTimer: { active: false, remaining: 0, total: 0 },
  workoutStartTime: null
};

// ============ STORAGE ============
function loadData() {
  try {
    const saved = localStorage.getItem('mFitnessData');
    if (saved) {
      const data = JSON.parse(saved);
      state.workouts = data.workouts || [];
      state.personalRecords = data.personalRecords || {};
      state.selectedProgram = data.selectedProgram || 'gluteFocus';
      state.settings = { ...state.settings, ...data.settings };
      if (state.settings.theme === 'light') {
        document.body.classList.add('light-mode');
      }
    }
  } catch(e) { console.error('Load error:', e); }
}

function saveData() {
  try {
    localStorage.setItem('mFitnessData', JSON.stringify({
      workouts: state.workouts,
      personalRecords: state.personalRecords,
      selectedProgram: state.selectedProgram,
      settings: state.settings
    }));
  } catch(e) { console.error('Save error:', e); }
}

// ============ TIMER FUNCTIONS ============
let timerInterval = null;
let workoutInterval = null;

function startRestTimer(seconds) {
  state.restTimer = { active: true, remaining: seconds, total: seconds };
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    state.restTimer.remaining--;
    if (state.restTimer.remaining <= 0) {
      stopRestTimer();
      if (state.settings.restTimer.sound) playBeep();
      if (state.settings.restTimer.vibration && navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }
    render();
  }, 1000);
  render();
}

function stopRestTimer() {
  state.restTimer.active = false;
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
}

function playBeep() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = 800;
    gain.gain.value = 0.3;
    osc.start();
    osc.stop(ctx.currentTime + 0.3);
  } catch(e) {}
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${s.toString().padStart(2, '0')}`;
}

function getWorkoutDuration() {
  if (!state.workoutStartTime) return '0:00';
  const elapsed = Math.floor((Date.now() - state.workoutStartTime) / 1000);
  return formatTime(elapsed);
}

function updateTimerDisplay() {
  const timerEl = document.getElementById('workout-timer');
  if (timerEl) {
    timerEl.textContent = getWorkoutDuration();
  }
}

// ============ WORKOUT FUNCTIONS ============
function startWorkout(name, exercises) {
  state.currentWorkout = {
    id: Date.now(),
    name,
    date: new Date().toISOString(),
    exercises: exercises.map(ex => ({
      name: ex,
      type: CARDIO_EXERCISES.includes(ex) ? 'cardio' : 'strength',
      sets: CARDIO_EXERCISES.includes(ex) ? [] : [{ type: '1', weight: '', reps: '', completed: false }],
      duration: '',
      distance: '',
      calories: ''
    }))
  };
  state.workoutStartTime = Date.now();
  workoutInterval = setInterval(updateTimerDisplay, 1000);
  state.activeTab = 'workout';
  autoFillFromHistory();
  render();
}

function autoFillFromHistory() {
  if (!state.currentWorkout) return;
  // workouts are stored newest first (unshift in finishWorkout)
  state.currentWorkout.exercises.forEach(ex => {
    if (ex.type === 'strength') {
      // Find the most recent workout containing this exercise with completed sets
      for (const w of state.workouts) {
        const matchingEx = w.exercises.find(e => 
          e.name === ex.name && e.type === 'strength' && e.sets?.some(s => s.completed && s.weight && s.reps)
        );
        if (matchingEx) {
          // Get the last completed set from that exercise
          const completedSets = matchingEx.sets.filter(s => s.completed && s.weight && s.reps);
          if (completedSets.length > 0) {
            const lastSet = completedSets[completedSets.length - 1];
            ex.sets[0].weight = lastSet.weight;
            ex.sets[0].reps = lastSet.reps;
          }
          break; // Found most recent, stop searching
        }
      }
    }
  });
}

function finishWorkout() {
  if (!state.currentWorkout) return;
  state.currentWorkout.completedAt = new Date().toISOString();
  state.currentWorkout.duration = Math.floor((Date.now() - state.workoutStartTime) / 1000);
  
  // Update PRs
  state.currentWorkout.exercises.forEach(ex => {
    if (ex.type === 'strength') {
      ex.sets.forEach(set => {
        if (set.completed && set.weight && set.reps) {
          const pr = state.personalRecords[ex.name];
          if (!pr || parseFloat(set.weight) > parseFloat(pr.weight)) {
            state.personalRecords[ex.name] = {
              weight: set.weight,
              reps: set.reps,
              date: new Date().toISOString()
            };
          }
        }
      });
    }
  });
  
  state.workouts.unshift(state.currentWorkout);
  state.currentWorkout = null;
  state.workoutStartTime = null;
  if (workoutInterval) clearInterval(workoutInterval);
  stopRestTimer();
  saveData();
  render();
}

function cancelWorkout() {
  if (confirm('Cancel workout? All progress will be lost.')) {
    state.currentWorkout = null;
    state.workoutStartTime = null;
    if (workoutInterval) clearInterval(workoutInterval);
    stopRestTimer();
    render();
  }
}

function addSet(exerciseIndex) {
  const ex = state.currentWorkout.exercises[exerciseIndex];
  if (ex.type === 'strength') {
    const lastSet = ex.sets[ex.sets.length - 1];
    ex.sets.push({
      type: '1',
      weight: lastSet?.weight || '',
      reps: lastSet?.reps || '',
      completed: false
    });
    render();
  }
}

function removeSet(exerciseIndex, setIndex) {
  const ex = state.currentWorkout.exercises[exerciseIndex];
  ex.sets.splice(setIndex, 1);
  if (ex.sets.length === 0) {
    ex.sets.push({ type: '1', weight: '', reps: '', completed: false });
  }
  render();
}

function toggleSetComplete(exerciseIndex, setIndex) {
  const set = state.currentWorkout.exercises[exerciseIndex].sets[setIndex];
  set.completed = !set.completed;
  if (set.completed && state.settings.restTimer.default > 0) {
    startRestTimer(state.settings.restTimer.default);
  }
  render();
}

function updateSet(exerciseIndex, setIndex, field, value) {
  state.currentWorkout.exercises[exerciseIndex].sets[setIndex][field] = value;
}

function updateCardio(exerciseIndex, field, value) {
  state.currentWorkout.exercises[exerciseIndex][field] = value;
}

function cycleSetType(exerciseIndex, setIndex) {
  const set = state.currentWorkout.exercises[exerciseIndex].sets[setIndex];
  const types = ['W', '1', '2', '3', 'F'];
  const idx = types.indexOf(set.type);
  set.type = types[(idx + 1) % types.length];
  render();
}

function addExerciseToWorkout(name) {
  if (!state.currentWorkout) return;
  state.currentWorkout.exercises.push({
    name,
    type: CARDIO_EXERCISES.includes(name) ? 'cardio' : 'strength',
    sets: CARDIO_EXERCISES.includes(name) ? [] : [{ type: '1', weight: '', reps: '', completed: false }],
    duration: '',
    distance: '',
    calories: ''
  });
  render();
}

function removeExercise(index) {
  state.currentWorkout.exercises.splice(index, 1);
  render();
}

function toggleWorkoutExpand(workoutId) {
  state.expandedWorkout = state.expandedWorkout === workoutId ? null : workoutId;
  render();
}

function deleteWorkout(workoutId) {
  if (confirm('Delete this workout? This cannot be undone.')) {
    state.workouts = state.workouts.filter(w => w.id !== workoutId);
    state.expandedWorkout = null;
    saveData();
    render();
  }
}

// ============ SETTINGS & EXPORT ============
function toggleTheme() {
  state.settings.theme = state.settings.theme === 'dark' ? 'light' : 'dark';
  document.body.classList.toggle('light-mode');
  saveData();
  render();
}

function exportData() {
  const data = JSON.stringify({
    workouts: state.workouts,
    personalRecords: state.personalRecords,
    selectedProgram: state.selectedProgram,
    settings: state.settings,
    exportDate: new Date().toISOString()
  }, null, 2);
  
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `m-fitness-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        if (data.workouts) state.workouts = data.workouts;
        if (data.personalRecords) state.personalRecords = data.personalRecords;
        if (data.selectedProgram) state.selectedProgram = data.selectedProgram;
        if (data.settings) state.settings = { ...state.settings, ...data.settings };
        saveData();
        alert('Data imported successfully!');
        render();
      } catch(e) {
        alert('Invalid backup file');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// ============ ICONS ============
const icons = {
  dumbbell: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5h11M6.5 17.5h11M3 10.5V6.5a1 1 0 0 1 1-1h1.5a1 1 0 0 1 1 1v11a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4M21 10.5V6.5a1 1 0 0 0-1-1h-1.5a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1H20a1 1 0 0 0 1-1v-4"/></svg>',
  calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
  trophy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>',
  settings: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
  plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>',
  check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
  x: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>',
  play: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
  pause: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>',
  sun: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>',
  moon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
  clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
  download: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
  upload: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
  heart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
  back: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>',
  home: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>'
};

// ============ NAVIGATION ============
function goHome() {
  if (state.currentWorkout) {
    if (confirm('Cancel workout? All progress will be lost.')) {
      state.currentWorkout = null;
      state.workoutStartTime = null;
      if (workoutInterval) clearInterval(workoutInterval);
      stopRestTimer();
      state.activeTab = 'workout';
      render();
    }
  } else {
    state.activeTab = 'workout';
    render();
  }
}

// ============ RENDER ============
function render() {
  // Save scroll position and focused element
  const scrollY = window.scrollY;
  const activeEl = document.activeElement;
  const activeId = activeEl?.id || null;
  const activeDataId = activeEl?.dataset?.inputId || null;
  const selectionStart = activeEl?.selectionStart;
  const selectionEnd = activeEl?.selectionEnd;
  
  const app = document.getElementById('app');
  
  app.innerHTML = `
    <!-- Header -->
    <header class="header">
      <div class="logo" onclick="goHome()" style="cursor:pointer;">
        ${state.currentWorkout ? `<div class="logo-icon">${icons.back}</div>` : `<div class="logo-icon">${icons.home}</div>`}
        <span class="logo-text">M Fitness</span>
      </div>
      <div class="header-right">
        ${state.currentWorkout ? `<span class="workout-timer">${icons.clock} <span id="workout-timer">${getWorkoutDuration()}</span></span>` : ''}
        <button class="theme-toggle" onclick="toggleTheme()">
          ${state.settings.theme === 'dark' ? icons.sun : icons.moon}
        </button>
      </div>
    </header>
    
    <!-- Navigation -->
    <nav class="nav">
      <button class="nav-btn ${state.activeTab === 'workout' ? 'active' : ''}" onclick="state.activeTab='workout';render()">
        ${icons.dumbbell}
        <span>Workout</span>
      </button>
      <button class="nav-btn ${state.activeTab === 'programs' ? 'active' : ''}" onclick="state.activeTab='programs';render()">
        ${icons.calendar}
        <span>Programs</span>
      </button>
      <button class="nav-btn ${state.activeTab === 'records' ? 'active' : ''}" onclick="state.activeTab='records';render()">
        ${icons.trophy}
        <span>PRs</span>
      </button>
      <button class="nav-btn ${state.activeTab === 'settings' ? 'active' : ''}" onclick="state.activeTab='settings';render()">
        ${icons.settings}
        <span>Settings</span>
      </button>
    </nav>
    
    <!-- Main Content -->
    <main class="main">
      ${renderTab()}
    </main>
    
    <!-- Rest Timer Overlay -->
    ${state.restTimer.active ? renderRestTimer() : ''}
  `;
  
  // Restore scroll position
  window.scrollTo(0, scrollY);
  
  // Restore focus
  if (activeDataId) {
    const el = document.querySelector(`[data-input-id="${activeDataId}"]`);
    if (el) {
      el.focus();
      if (typeof selectionStart === 'number') {
        el.setSelectionRange(selectionStart, selectionEnd);
      }
    }
  }
}

function renderTab() {
  switch(state.activeTab) {
    case 'workout': return renderWorkoutTab();
    case 'programs': return renderProgramsTab();
    case 'records': return renderRecordsTab();
    case 'settings': return renderSettingsTab();
    default: return '';
  }
}

function renderRestTimer() {
  const progress = (state.restTimer.remaining / state.restTimer.total) * 100;
  return `
    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;">
      <div style="font-size:72px;font-weight:700;color:var(--primary);margin-bottom:16px;">${formatTime(state.restTimer.remaining)}</div>
      <div style="width:200px;height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden;margin-bottom:24px;">
        <div style="width:${progress}%;height:100%;background:var(--primary);transition:width 1s linear;"></div>
      </div>
      <div style="display:flex;gap:12px;">
        <button onclick="state.restTimer.remaining+=15;render()" style="padding:12px 20px;background:var(--bg-input);border:none;border-radius:10px;color:var(--text);font-size:14px;cursor:pointer;">+15s</button>
        <button onclick="stopRestTimer();render()" style="padding:12px 20px;background:var(--danger);border:none;border-radius:10px;color:#fff;font-size:14px;cursor:pointer;">Skip</button>
      </div>
    </div>
  `;
}

function renderWorkoutTab() {
  if (!state.currentWorkout) {
    return renderStartWorkout();
  }
  return renderActiveWorkout();
}

function renderStartWorkout() {
  const program = PROGRAMS[state.selectedProgram];
  
  // Store workout data for click handlers
  program.days.forEach((day, i) => {
    window._workoutData['program_' + i] = { name: program.name + ' - ' + day.name, exercises: day.exercises };
  });
  state.workouts.slice(0, 5).forEach(w => {
    window._workoutData['repeat_' + w.id] = { name: w.name, exercises: w.exercises.map(e => e.name) };
  });
  
  return `
    <div class="card">
      <div class="card-title">${icons.play} Start Workout</div>
      <button onclick="startWorkout('Custom Workout', [])" style="width:100%;padding:16px;background:var(--primary-dim);border:1px solid var(--primary);border-radius:12px;color:var(--text);font-size:15px;cursor:pointer;display:flex;align-items:center;gap:10px;margin-bottom:12px;">
        ${icons.plus} Custom Workout
      </button>
      
      <div style="color:var(--text-dim);font-size:13px;margin:16px 0 8px;">From ${program.name}:</div>
      ${program.days.map((day, i) => `
        <button onclick="startWorkoutFromData('program_${i}')" 
          style="width:100%;padding:14px 16px;background:var(--bg-input);border:none;border-radius:12px;color:var(--text);font-size:14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span>${day.name}</span>
          <span style="color:var(--text-dim);font-size:12px;">${day.exercises.length} exercises</span>
        </button>
      `).join('')}
    </div>
    
    ${state.workouts.length > 0 ? `
      <div class="card">
        <div class="card-title">${icons.clock} Recent Workouts</div>
        ${state.workouts.slice(0, 5).map(w => {
          const isExpanded = state.expandedWorkout === w.id;
          return `
          <div style="background:var(--bg-input);border-radius:10px;margin-bottom:8px;overflow:hidden;">
            <div onclick="toggleWorkoutExpand(${w.id})" style="padding:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
              <div>
                <div style="font-weight:500;margin-bottom:4px;">${escapeHtml(w.name)}</div>
                <div style="font-size:12px;color:var(--text-dim);">
                  ${new Date(w.date).toLocaleDateString('el-GR')} â€¢ ${w.exercises.length} exercises ${w.duration ? 'â€¢ ' + formatTime(w.duration) : ''}
                </div>
              </div>
              <span style="color:var(--text-dim);transform:rotate(${isExpanded ? '180deg' : '0deg'});transition:transform 0.2s;">â–¼</span>
            </div>
            ${isExpanded ? `
              <div style="padding:0 12px 12px;border-top:1px solid var(--border);">
                <div style="padding-top:12px;display:flex;flex-direction:column;gap:6px;">
                  ${w.exercises.map(ex => `
                    <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
                      <span>${escapeHtml(ex.name)}</span>
                      <span style="color:var(--text-dim);">
                        ${ex.type === 'cardio' 
                          ? (ex.duration || '-') 
                          : (ex.sets?.filter(s => s.completed).length || 0) + '/' + (ex.sets?.length || 0) + ' sets'
                        }
                      </span>
                    </div>
                  `).join('')}
                </div>
                <div style="display:flex;gap:8px;margin-top:12px;">
                  <button onclick="event.stopPropagation();startWorkoutFromData('repeat_${w.id}')" 
                    style="flex:1;padding:10px;background:var(--primary-dim);border:1px solid var(--primary);border-radius:8px;color:var(--primary);font-size:12px;cursor:pointer;">
                    Repeat Workout
                  </button>
                  <button onclick="event.stopPropagation();deleteWorkout(${w.id})" 
                    style="padding:10px;background:rgba(232,160,160,0.2);border:none;border-radius:8px;color:var(--danger);cursor:pointer;">
                    ${icons.trash}
                  </button>
                </div>
              </div>
            ` : ''}
          </div>
        `}).join('')}
      </div>
    ` : ''}
  `;
}

function renderActiveWorkout() {
  return `
    <!-- Workout Header -->
    <div class="card" style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-weight:600;">${state.currentWorkout.name}</div>
        <div style="font-size:12px;color:var(--text-dim);">${new Date(state.currentWorkout.date).toLocaleDateString('el-GR')}</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="cancelWorkout()" style="padding:10px;background:var(--danger);background:rgba(232,160,160,0.2);border:none;border-radius:10px;color:var(--danger);cursor:pointer;">
          ${icons.x}
        </button>
        <button onclick="finishWorkout()" style="padding:10px 16px;background:var(--success);background:rgba(158,212,190,0.2);border:none;border-radius:10px;color:var(--success);cursor:pointer;display:flex;align-items:center;gap:6px;font-weight:500;">
          ${icons.check} Finish
        </button>
      </div>
    </div>
    
    <!-- Exercises -->
    ${state.currentWorkout.exercises.map((ex, exIdx) => 
      ex.type === 'cardio' ? renderCardioExercise(ex, exIdx) : renderStrengthExercise(ex, exIdx)
    ).join('')}
    
    <!-- Add Exercise -->
    <div class="card">
      <div class="card-title">${icons.plus} Add Exercise</div>
      <div style="max-height:300px;overflow-y:auto;">
        ${Object.entries(EXERCISES).map(([key, cat]) => `
          <div style="margin-bottom:12px;">
            <div style="font-size:13px;color:var(--text-dim);margin-bottom:8px;">${cat.emoji} ${cat.name}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
              ${cat.exercises.filter(ex => !state.currentWorkout.exercises.some(e => e.name === ex)).map(ex => `
                <button onclick="addExerciseToWorkout('${ex}')" 
                  style="padding:10px 8px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);font-size:12px;cursor:pointer;text-align:left;">
                  ${ex}
                </button>
              `).join('')}
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderStrengthExercise(ex, exIdx) {
  return `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">${icons.dumbbell} ${ex.name}</div>
        <button onclick="removeExercise(${exIdx})" style="padding:8px;background:transparent;border:none;color:var(--text-dim);cursor:pointer;">${icons.trash}</button>
      </div>
      
      <!-- Header Row -->
      <div style="display:grid;grid-template-columns:44px 1fr 1fr 44px 44px;gap:6px;margin-bottom:8px;padding:0 4px;">
        <div style="font-size:11px;color:var(--text-dim);text-align:center;">TYPE</div>
        <div style="font-size:11px;color:var(--text-dim);text-align:center;">KG</div>
        <div style="font-size:11px;color:var(--text-dim);text-align:center;">REPS</div>
        <div></div>
        <div></div>
      </div>
      
      <!-- Sets -->
      ${ex.sets.map((set, setIdx) => `
        <div style="display:grid;grid-template-columns:44px 1fr 1fr 44px 44px;gap:6px;margin-bottom:6px;">
          <button onclick="cycleSetType(${exIdx},${setIdx})" 
            style="height:44px;background:${SET_TYPES.find(t=>t.id===set.type)?.color || 'var(--primary)'}33;border:none;border-radius:8px;color:${SET_TYPES.find(t=>t.id===set.type)?.color || 'var(--primary)'};font-weight:600;font-size:13px;cursor:pointer;">
            ${set.type}
          </button>
          <input type="number" inputmode="decimal" value="${set.weight}" placeholder="0" 
            data-input-id="weight-${exIdx}-${setIdx}"
            oninput="updateSet(${exIdx},${setIdx},'weight',this.value)"
            style="height:44px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);text-align:center;font-size:16px;width:100%;">
          <input type="number" inputmode="numeric" value="${set.reps}" placeholder="0" 
            data-input-id="reps-${exIdx}-${setIdx}"
            oninput="updateSet(${exIdx},${setIdx},'reps',this.value)"
            style="height:44px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);text-align:center;font-size:16px;width:100%;">
          <button onclick="toggleSetComplete(${exIdx},${setIdx})"
            style="height:44px;width:44px;background:${set.completed ? 'var(--success)' : 'var(--bg-input)'};border:none;border-radius:8px;color:${set.completed ? '#fff' : 'var(--text-dim)'};cursor:pointer;">
            ${icons.check}
          </button>
          <button onclick="removeSet(${exIdx},${setIdx})"
            style="height:44px;width:44px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text-dim);cursor:pointer;">
            ${icons.trash}
          </button>
        </div>
      `).join('')}
      
      <button onclick="addSet(${exIdx})" 
        style="width:100%;padding:12px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text-dim);font-size:13px;cursor:pointer;margin-top:4px;">
        + Add Set
      </button>
    </div>
  `;
}

function renderCardioExercise(ex, exIdx) {
  return `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">${icons.heart} ${ex.name}</div>
        <button onclick="removeExercise(${exIdx})" style="padding:8px;background:transparent;border:none;color:var(--text-dim);cursor:pointer;">${icons.trash}</button>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
        <div>
          <label style="font-size:11px;color:var(--text-dim);display:block;margin-bottom:4px;">DURATION</label>
          <input type="text" value="${ex.duration}" placeholder="mm:ss" 
            data-input-id="cardio-duration-${exIdx}"
            oninput="updateCardio(${exIdx},'duration',this.value)"
            style="width:100%;height:44px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);text-align:center;font-size:16px;">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text-dim);display:block;margin-bottom:4px;">DISTANCE (km)</label>
          <input type="number" inputmode="decimal" value="${ex.distance}" placeholder="0" 
            data-input-id="cardio-distance-${exIdx}"
            oninput="updateCardio(${exIdx},'distance',this.value)"
            style="width:100%;height:44px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);text-align:center;font-size:16px;">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text-dim);display:block;margin-bottom:4px;">CALORIES</label>
          <input type="number" inputmode="numeric" value="${ex.calories}" placeholder="0" 
            data-input-id="cardio-calories-${exIdx}"
            oninput="updateCardio(${exIdx},'calories',this.value)"
            style="width:100%;height:44px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);text-align:center;font-size:16px;">
        </div>
      </div>
    </div>
  `;
}

function renderProgramsTab() {
  const selectedProg = PROGRAMS[state.selectedProgram];
  
  // Store workout data for click handlers
  selectedProg.days.forEach((day, i) => {
    window._workoutData['sched_' + i] = { name: selectedProg.name + ' - ' + day.name, exercises: day.exercises };
  });
  
  let exIdx = 0;
  Object.values(EXERCISES).forEach(cat => {
    cat.exercises.forEach(ex => {
      window._workoutData['quick_' + exIdx] = { name: 'Quick: ' + ex.split(' / ')[0], exercises: [ex] };
      exIdx++;
    });
  });
  
  let quickIdx = 0;
  
  return `
    <div class="card">
      <div class="card-title">${icons.calendar} Quick Start Programs</div>
      ${Object.entries(PROGRAMS).map(([key, program]) => `
        <button onclick="state.selectedProgram='${key}';saveData();render()"
          style="width:100%;padding:16px;background:${state.selectedProgram === key ? 'var(--primary-dim)' : 'var(--bg-input)'};border:${state.selectedProgram === key ? '1px solid var(--primary)' : 'none'};border-radius:12px;color:var(--text);cursor:pointer;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="text-align:left;">
            <div style="font-weight:500;">${program.name}</div>
            <div style="font-size:12px;color:var(--text-dim);">${program.days.length} days per week</div>
          </div>
          ${state.selectedProgram === key ? `<span style="color:var(--primary);">${icons.check}</span>` : ''}
        </button>
      `).join('')}
    </div>
    
    <div class="card">
      <div class="card-title">${icons.calendar} ${selectedProg.name} Schedule</div>
      ${selectedProg.days.map((day, i) => `
        <div style="padding:14px;background:var(--bg-input);border-radius:10px;margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-weight:500;">${day.name}</span>
            <button onclick="startWorkoutFromData('sched_${i}')"
              style="padding:6px 12px;background:var(--primary);border:none;border-radius:6px;color:#fff;font-size:11px;cursor:pointer;">
              Start
            </button>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;">
            ${day.exercises.map(ex => `
              <span style="padding:4px 10px;background:var(--primary-dim);border-radius:6px;font-size:11px;color:var(--primary);">${ex.split(' / ')[0]}</span>
            `).join('')}
          </div>
        </div>
      `).join('')}
    </div>
    
    <div class="card">
      <div class="card-title">${icons.dumbbell} All Exercises</div>
      <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Tap to start a quick workout with any exercise</div>
      ${Object.entries(EXERCISES).map(([key, cat]) => `
        <div style="margin-bottom:16px;">
          <div style="font-size:13px;color:var(--text-dim);margin-bottom:8px;">${cat.emoji} ${cat.name}</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;">
            ${cat.exercises.map(ex => {
              const idx = quickIdx++;
              return `
              <button onclick="startWorkoutFromData('quick_${idx}')"
                style="padding:8px 12px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);font-size:12px;cursor:pointer;">
                ${ex.split(' / ')[0]}
              </button>
            `}).join('')}
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderRecordsTab() {
  const prs = Object.entries(state.personalRecords).sort((a, b) => parseFloat(b[1].weight) - parseFloat(a[1].weight));
  
  return `
    <div class="card">
      <div class="card-title">${icons.trophy} Personal Records</div>
      ${prs.length > 0 ? prs.map(([exercise, pr]) => `
        <div style="padding:14px;background:var(--bg-input);border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:500;">${exercise}</div>
            <div style="font-size:12px;color:var(--text-dim);">${new Date(pr.date).toLocaleDateString('el-GR')}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:20px;font-weight:700;color:var(--primary);">${pr.weight} kg</div>
            <div style="font-size:12px;color:var(--text-dim);">${pr.reps} reps</div>
          </div>
        </div>
      `).join('') : `
        <div style="text-align:center;padding:40px;color:var(--text-dim);">
          <div style="margin-bottom:8px;">${icons.trophy}</div>
          <div>No personal records yet.</div>
          <div style="font-size:13px;">Complete workouts to set PRs!</div>
        </div>
      `}
    </div>
  `;
}

function renderSettingsTab() {
  return `
    <div class="card">
      <div class="card-title">${icons.settings} Settings</div>
      
      <!-- Rest Timer -->
      <div style="margin-bottom:20px;">
        <label style="font-size:13px;color:var(--text-dim);display:block;margin-bottom:8px;">Default Rest Timer (seconds)</label>
        <div style="display:flex;gap:8px;">
          ${[60, 90, 120, 180].map(sec => `
            <button onclick="state.settings.restTimer.default=${sec};saveData();render()"
              style="flex:1;padding:12px;background:${state.settings.restTimer.default === sec ? 'var(--primary)' : 'var(--bg-input)'};border:none;border-radius:8px;color:${state.settings.restTimer.default === sec ? '#fff' : 'var(--text)'};cursor:pointer;font-size:14px;">
              ${sec}s
            </button>
          `).join('')}
        </div>
      </div>
      
      <!-- Sound & Vibration -->
      <div style="margin-bottom:20px;">
        <label style="font-size:13px;color:var(--text-dim);display:block;margin-bottom:8px;">Timer Alerts</label>
        <div style="display:flex;gap:8px;">
          <button onclick="state.settings.restTimer.sound=!state.settings.restTimer.sound;saveData();render()"
            style="flex:1;padding:12px;background:${state.settings.restTimer.sound ? 'var(--primary)' : 'var(--bg-input)'};border:none;border-radius:8px;color:${state.settings.restTimer.sound ? '#fff' : 'var(--text)'};cursor:pointer;">
            ðŸ”Š Sound ${state.settings.restTimer.sound ? 'ON' : 'OFF'}
          </button>
          <button onclick="state.settings.restTimer.vibration=!state.settings.restTimer.vibration;saveData();render()"
            style="flex:1;padding:12px;background:${state.settings.restTimer.vibration ? 'var(--primary)' : 'var(--bg-input)'};border:none;border-radius:8px;color:${state.settings.restTimer.vibration ? '#fff' : 'var(--text)'};cursor:pointer;">
            ðŸ“³ Vibration ${state.settings.restTimer.vibration ? 'ON' : 'OFF'}
          </button>
        </div>
      </div>
      
      <!-- Theme -->
      <div style="margin-bottom:20px;">
        <label style="font-size:13px;color:var(--text-dim);display:block;margin-bottom:8px;">Theme</label>
        <button onclick="toggleTheme()"
          style="width:100%;padding:14px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
          ${state.settings.theme === 'dark' ? icons.moon + ' Dark Mode' : icons.sun + ' Light Mode'}
        </button>
      </div>
    </div>
    
    <!-- Export/Import -->
    <div class="card">
      <div class="card-title">${icons.download} Backup & Restore</div>
      <div style="display:flex;gap:8px;">
        <button onclick="exportData()"
          style="flex:1;padding:14px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
          ${icons.download} Export
        </button>
        <button onclick="importData()"
          style="flex:1;padding:14px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
          ${icons.upload} Import
        </button>
      </div>
      <div style="font-size:11px;color:var(--text-dim);margin-top:12px;text-align:center;">
        ${state.workouts.length} workouts â€¢ ${Object.keys(state.personalRecords).length} PRs saved
      </div>
    </div>
    
    <!-- Stats -->
    <div class="card">
      <div class="card-title">${icons.trophy} Stats</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="padding:16px;background:var(--bg-input);border-radius:10px;text-align:center;">
          <div style="font-size:28px;font-weight:700;color:var(--primary);">${state.workouts.length}</div>
          <div style="font-size:12px;color:var(--text-dim);">Total Workouts</div>
        </div>
        <div style="padding:16px;background:var(--bg-input);border-radius:10px;text-align:center;">
          <div style="font-size:28px;font-weight:700;color:var(--primary);">${Object.keys(state.personalRecords).length}</div>
          <div style="font-size:12px;color:var(--text-dim);">Personal Records</div>
        </div>
      </div>
    </div>
  `;
}

// ============ INIT ============
loadData();
render();
</script>
</body>
</html>
